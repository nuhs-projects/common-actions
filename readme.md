# Common Github Actions

Add automated linting, testing, secret scanning and deployment to your repository.

Lint, scan for secrets and build the `test` stage of a Dockerfile:

```yaml
# .github/workflows/your-workflow.yml
name: Lint and check lockfile

on:
  push:
  pull_request:

permissions:
  contents: read
  id-token: write

jobs:
  lint:
    uses: nuhs-projects/common-actions/.github/workflows/python-lint.yml@main
    with:
      working_directory: backend

  test:
    uses: nuhs-projects/common-actions/.github/workflows/build-and-push.yml@main
    with:
      ecr_repository: namespace/repo
      target: test
      push: false
```

Build and push the image to the Dev AWS ECR, then deploy it to a K8S cluster:

```yaml
# .github/workflows/build-and-deploy.yml
name: Build and Deploy

on:
  push:
  tag:

permissions:
  contents: write
  id-token: write

jobs:
  build:
    uses: nuhs-projects/common-actions/.github/workflows/build-and-push.yml@main
    with:
      ecr_repository: namespace/repo
      target: deployment
      push: true

  deploy:
    uses: nuhs-projects/common-actions/.github/workflows/deploy.yml@main
    needs: build
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      iam_role: 12345
      k8s_cluster_name: dev
      k8s_namespace: dev
      k8s_yaml
```


## Notes for the `deploy.yml` action

This action uses `kompose` to generate a base K8S yaml from a Docker `compose.yml` and then `kustomize` to generate environment-specific K8S yamls for specific environments.

Your repository needs to have a `deployment` folder in the root (name is customizable), containing:

- `compose.yml`

  - The service to be exposed via an Ingress must contain the following label:
    ```yaml
    labels:
      kompose.service.expose: kompose.host
    ```

- Kustomize overlays (all are optional):
  - `overlays/dev/kustomization.yaml`
  - `overlays/staging/kustomization.yaml`
  - `overlays/production/kustomization.yaml`
- Additional information regarding Kustomize overlays:
  - For the staging and production yamls, under the `image` section, you should not indicate a version - the version tag is autogenerated by the action when you push a tag to Github.
  - In the `resources` section, you should include the `base.yaml` as follows:
    ```yaml
    resources:
      - ../../base
    ```

## Notes

- Tests are run by building the `test` stage of a Dockerfile, as shown above.
- Naming convention: `${language}-${workflow-name}`.
  - For actions applicable to all languages, omit `${language}`.
- Our Github Free plan [doesn't support] organization-level secrets and variables in private repositories.
- Called workflows only see the caller workflow repository's variables and secrets.
- Workflow files cannot [be in folders].

[doesn't support]: https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/store-information-in-variables#creating-configuration-variables-for-an-organization
[be in folders]: https://github.com/orgs/community/discussions/10773
